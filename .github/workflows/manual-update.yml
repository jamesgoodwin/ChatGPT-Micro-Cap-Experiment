name: Manual Portfolio Update

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      update_message:
        description: 'Custom commit message (optional)'
        required: false
        default: ''
        type: string

permissions:
  contents: write  # Allow workflow to commit and push changes

jobs:
  manual-portfolio-update:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run trading script update
      run: |
        echo "🚀 Running manual portfolio update..."
        # Run the trading script non-interactively
        echo "" | python "Scripts and CSV Files/Trading_Script.py" || echo "⚠️ Trading script completed with warnings"
        echo "✅ Trading script execution completed"
    
    - name: Generate portfolio summary report
      run: |
        python -c "
        from trading_script import load_latest_portfolio_state, generate_portfolio_summary
        import os
        from datetime import datetime
        
        # Load current portfolio
        portfolio, cash = load_latest_portfolio_state('Scripts and CSV Files/chatgpt_portfolio_update.csv')
        
        # Generate summary
        summary = generate_portfolio_summary(portfolio, cash)
        
        # Create a daily report file
        report_date = datetime.now().strftime('%Y-%m-%d')
        generated_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S UTC')
        
        report_content = f'''# Portfolio Report - {report_date}

Generated at: {generated_time}

## Current Portfolio Status

{summary}

---
*This report was automatically generated by GitHub Actions*
'''
        
        # Ensure reports directory exists
        os.makedirs('reports', exist_ok=True)
        
        # Write report
        with open(f'reports/portfolio-report-{report_date}.md', 'w') as f:
            f.write(report_content)
        
        print(f'📊 Portfolio report generated: reports/portfolio-report-{report_date}.md')
        "
    
    - name: Configure git for auto-commits
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Actions Bot"
    
    - name: Commit all updates
      run: |
        # Add all changes
        git add .
        
        # Check if there are any changes to commit
        if [ -n "$(git status --porcelain)" ]; then
          echo "📝 Changes detected, committing updates..."
          
          # Use custom message if provided, otherwise use default
          if [ -n "${{ github.event.inputs.update_message }}" ]; then
            COMMIT_MSG="${{ github.event.inputs.update_message }}"
          else
            COMMIT_MSG="Manual portfolio update - $(date '+%Y-%m-%d %H:%M')"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
          echo "✅ All changes committed and pushed"
          
          # Output summary
          echo "🎉 Manual update completed successfully!"
          echo "📈 Portfolio data updated"
          echo "📊 Daily report generated"
          echo "💾 Changes committed to repository"
        else
          echo "ℹ️ No changes detected, nothing to commit"
        fi
